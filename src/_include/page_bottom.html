@@include('../blocks/vary-modal/vary-modal.html')

<!-- TV-channels modal -->
@@include('../blocks/tvch-modal/tvch-modal.html')
<!-- Select TV-channel modal -->
@@include('../blocks/tv-select-modal/tv-select-modal.html')

<script>
  "use strict";
  /**
   * Универсальная функция для определения текущего языка сайта.
   * Возвращает двухбуквенный код языка ('ru', 'en', ...).
   *
   * @param {Object} options
   * @param {string[]} [options.supportedLangs] - Массив поддерживаемых языков, например: ['ru', 'en', 'fr']
   * @param {string} [options.defaultLang] - Язык по умолчанию, если не найден (например, 'en')
   * @returns {string} Код языка
   */
  (function(){
    window.getCurrentLang = function(options = {}) {
      const { supportedLangs = ['uk', 'ru', 'en'], defaultLang = 'uk' } = options;
      // 1. Получаем из <html lang="">
      let lang = document.documentElement.lang;
      if (lang) {
        lang = lang.toLowerCase().slice(0, 2);
        if (!supportedLangs.length || supportedLangs.includes(lang)) {
          return lang;
        }
      }
      // 2. Получаем из URL: /ru/, /en/, /fr/...
      const pathMatch = window.location.pathname.match(/^\/([a-z]{2})(\/|$)/i);
      if (pathMatch) {
        lang = pathMatch[1].toLowerCase();
        if (!supportedLangs.length || supportedLangs.includes(lang)) {
          return lang;
        }
      }
      // 3. Возвращаем дефолтный язык
      return defaultLang;
    }
  }());
</script>

<script>
"use strict";
(function(){
  const varyModal = document.getElementById('varyModal');
  if (!varyModal) return;

  // Поле «Адреса»
  const addressInput = varyModal.querySelector('input[name="address"]');
  const addressLabel = addressInput ? addressInput.closest('label.field-text') : null;

  // Поле статуса белого IP (hidden)
  const ipStatusInput = varyModal.querySelector('#ipStatus');

  // Фиксируем последний клик по триггеру модалки (в capture, чтобы обойти слайдеры и вложенные элементы)
  document.addEventListener('click', function (ev) {
    const el = ev.target && ev.target.closest && ev.target.closest(
      '[data-bs-target="#varyModal"], [data-bs-toggle="modal"][data-bs-target="#varyModal"]'
    );
    if (el) window.varyModalLastTrigger = el;
  }, { capture: true });

  document.addEventListener('touchstart', function (ev) {
    const el = ev.target && ev.target.closest && ev.target.closest(
      '[data-bs-target="#varyModal"], [data-bs-toggle="modal"][data-bs-target="#varyModal"]'
    );
    if (el) window.varyModalLastTrigger = el;
  }, { capture: true, passive: true });

  // Нормализация текста
  function norm(s) {
    return String(s || '').toLowerCase().replace(/\s+/g, ' ').trim();
  }

  // Проверка: текст относится к действию «подключение»
  function isConnectText(text) {
    const s = norm(text);
    if (!s) return false;
    // Базовые корни для укр/рус (при необходимости добавите варианты)
    return (
      /підключ/.test(s) || // підключити/підключитись/підключення
      /подключ/.test(s) || // подключить/подключение
      /\bconnect/.test(s)  // на случай англ. «connect»
    );
  }

  // Проверка: элемент-триггер «подключательный»?
  // Без обязательных data-атрибутов — опираемся на тексты.
  function isConnectActionFromElement(el) {
    if (!el) return false;

    // Собираем набор возможных текстов
    const texts = [];
    texts.push(el.getAttribute && el.getAttribute('data-bs-whatever'));
    texts.push(el.getAttribute && el.getAttribute('aria-label'));
    texts.push(el.getAttribute && el.getAttribute('title'));
    texts.push(el.textContent);

    // Поиск ближайшего «контента» в пределах слайда/hero-секции
    try {
      const container = el.closest('.swiper-slide, .hero, .hero__slide, .hero_slide, .hero__item, .promo, .banner, section');
      if (container) {
        const header = container.querySelector('h1,h2,h3,.hero_slide__title,.hero_slide_title,.title,.section-title');
        if (header) texts.push(header.textContent);
      }
    } catch (e) {}

    return texts.some(t => isConnectText(t));
  }

  // Показ/скрытие поля «Адреса»
  function setAddressVisibility(show, opts) {
    opts = opts || {};
    const allowFocus = typeof opts.allowFocus === 'boolean' ? opts.allowFocus : false;
    if (!addressLabel || !addressInput) return;

    if (show) {
      addressLabel.classList.remove('is-hidden');
      addressLabel.removeAttribute('aria-hidden');
      addressInput.removeAttribute('aria-hidden');
      if (allowFocus) {
        setTimeout(() => { try { addressInput.focus(); } catch (e) {} }, 50);
      }
    } else {
      addressLabel.classList.add('is-hidden');
      addressLabel.setAttribute('aria-hidden', 'true');
      addressInput.setAttribute('aria-hidden', 'true');
      try { addressInput.value = ''; } catch (e) {}
    }
  }

  // Статус белого IP для карточки тарифа
  function getIpStatus(tariffCard) {
    if (!tariffCard) return '';

    const mode = (tariffCard.dataset.ipMode || '').toLowerCase();
    const checkbox = tariffCard.querySelector('input.field-toggler__input[data-ip-cost]');

    if (mode === 'off') {
      return 'Білий IP відсутній';
    }

    if (mode === 'on') {
      return 'Білий IP увімкнено';
    }

    if (mode === 'optional') {
      const isOn = checkbox && checkbox.checked;
      return isOn ? 'Білий IP увімкнено' : 'Білий IP відсутній';
    }

    // Если режима нет или пустой — трактуем как "off" (IP нет)
    return 'Білий IP відсутній';
  }

  // Надёжно находим триггер открытия
  function resolveTrigger(event) {
    let btn = event.relatedTarget || window.varyModalLastTrigger || document.activeElement || null;

    // Если фокус на вложенном/неподходящем узле — поднимаемся к реальному триггеру
    if (btn && btn.matches && !btn.matches('[data-bs-target="#varyModal"], [data-bs-toggle="modal"][data-bs-target="#varyModal"]')) {
      if (btn.closest) {
        btn = btn.closest('[data-bs-target="#varyModal"], [data-bs-toggle="modal"][data-bs-target="#varyModal"]');
      }
    }

    if (!btn) {
      // Фолбэк: берём первый видимый триггер на странице
      const all = Array
        .from(document.querySelectorAll('[data-bs-target="#varyModal"], [data-bs-toggle="modal"][data-bs-target="#varyModal"]'))
        .filter(el => el.offsetParent !== null);
      if (all.length) btn = all[0];
    }
    return btn || null;
  }

  // Заполнение полей для тарифного сценария (кнопка внутри .tariff-card)
  function fillTariffScenario(tariffCard, button, titleFromBtn) {
    const modalTitle = varyModal.querySelector('.vary-modal__title');
    const modalSubtitle = varyModal.querySelector('.vary-modal__subtitle');
    const ipTariffInput = varyModal.querySelector('#ipTariff');
    const tvTariffInput = varyModal.querySelector('#tvTariff');
    const totalPriceInput = varyModal.querySelector('#totalPrice');

    modalTitle.textContent = titleFromBtn || 'Підключити тариф';
    if (ipTariffInput) ipTariffInput.value = titleFromBtn || '';

    // Цена — из карточки (поддержим альтернативные селекторы на всякий случай)
    const priceEl = tariffCard.querySelector('.tariff-card__opt-item--price strong, .tariff-card__price strong, [data-role="price"]');
    if (priceEl && totalPriceInput) {
      totalPriceInput.value = priceEl.textContent.trim();
    }

    // IPTV
    if (tariffCard.dataset.selectedIptv) {
      if (tvTariffInput) tvTariffInput.value = tariffCard.dataset.selectedIptv;
      if (modalSubtitle) {
        modalSubtitle.textContent = tariffCard.dataset.selectedIptv;
        modalSubtitle.style.display = '';
      }
    } else {
      if (tvTariffInput) tvTariffInput.value = 'Без IPTV';
      if (modalSubtitle) {
        modalSubtitle.textContent = '';
        modalSubtitle.style.display = 'none';
      }
    }

    // Показ «Адреса», если триггер/текст указывает на подключение
    const shouldShowAddress = isConnectActionFromElement(button) || isConnectText(titleFromBtn);
    setAddressVisibility(shouldShowAddress, { allowFocus: false });

    // Статус белого IP — по согласованным правилам
    if (ipStatusInput) {
      ipStatusInput.value = getIpStatus(tariffCard);
    }
  }

  // Заполнение полей для общего сценария (не .tariff-card)
  function fillGeneralScenario(button, titleFromBtn) {
    const modalTitle = varyModal.querySelector('.vary-modal__title');
    const modalSubtitle = varyModal.querySelector('.vary-modal__subtitle');
    const ipTariffInput = varyModal.querySelector('#ipTariff');
    const tvTariffInput = varyModal.querySelector('#tvTariff');
    const totalPriceInput = varyModal.querySelector('#totalPrice');

    modalTitle.textContent = titleFromBtn || 'Замовити консультацію';

    // Очищаем «тарифные» поля
    if (ipTariffInput) ipTariffInput.value = '';
    if (tvTariffInput) tvTariffInput.value = '';
    if (totalPriceInput) totalPriceInput.value = '';

    if (modalSubtitle) {
      modalSubtitle.textContent = '';
      modalSubtitle.style.display = 'none';
    }

    // В общем сценарии тоже показываем адрес, если тексты указывают на «подключение»
    const shouldShowAddress = isConnectActionFromElement(button) || isConnectText(titleFromBtn);
    setAddressVisibility(shouldShowAddress, { allowFocus: false });

    // В общем сценарии ipStatus всегда пустой (по ТЗ)
    if (ipStatusInput) {
      ipStatusInput.value = '';
    }
  }

  // Открытие модалки: основной сценарий
  varyModal.addEventListener('show.bs.modal', event => {
    const button = resolveTrigger(event);
    const tariffCard = button ? (button.closest && button.closest('.tariff-card')) : null;

    const titleFromBtn =
      (button && (
        button.getAttribute('data-bs-whatever') ||
        button.getAttribute('aria-label') ||
        button.getAttribute('title') ||
        button.textContent
      )) || '';

    if (tariffCard) {
      // Тарифная карточка
      fillTariffScenario(tariffCard, button, titleFromBtn);
    } else {
      // Общая форма (Hero, баннеры и др.)
      fillGeneralScenario(button, titleFromBtn);
    }
  });

  // При закрытии — гарантированно скрываем и очищаем «Адреса»
  varyModal.addEventListener('hidden.bs.modal', () => {
    setAddressVisibility(false);
    try { window.varyModalLastTrigger = null; } catch (e) {}
    if (ipStatusInput) ipStatusInput.value = '';
  });

}());
</script>


<!-- <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script> -->
<script type="module" src="js/lazy-loader.js"></script>
<script src="js/lazy-lottie-init.js" defer></script>
<script src="js/lazy-maps-init.js" defer></script>
<script src="js/script.min.js" defer></script>
<script src="js/tv-select-modal.js" defer></script>
