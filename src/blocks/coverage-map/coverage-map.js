document.addEventListener('DOMContentLoaded', function () {

  const coverageMap = [{"uri":"map\/tychyny-pavla-pr\/9b","id":"71","pagetitle":"9\u0431","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"9\u0431\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4293093\",\"longitude\":\"30.603848\"}","sp_object":""},{"uri":"map\/tychyny-pavla-pr\/11","id":"72","pagetitle":"11","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"11\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.43076259999999\",\"longitude\":\"30.6073302\"}","sp_object":""},{"uri":"map\/tychyny-pavla-pr\/5","id":"67","pagetitle":"5","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"5\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4280716\",\"longitude\":\"30.5988107\"}","sp_object":""},{"uri":"map\/tychyny-pavla-pr\/5a","id":"68","pagetitle":"5\u0430","coverage_status":"0","backup_power":"24","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"5\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.42862539999999\",\"longitude\":\"30.6005389\"}","sp_object":""},{"uri":"map\/tychyny-pavla-pr\/9","id":"69","pagetitle":"9","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"9\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4293054\",\"longitude\":\"30.6038764\"}","sp_object":""},{"uri":"map\/tychyny-pavla-pr\/9a","id":"70","pagetitle":"9\u0430","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"9\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4301699\",\"longitude\":\"30.6009519\"}","sp_object":""},{"uri":"map\/sobornosti\/30a","id":"66","pagetitle":"30\u0430","coverage_status":"0","backup_power":"24","gmap":"{\"street\":\"\u0421\u043e\u0431\u043e\u0440\u043d\u043e\u0441\u0442\u0456\",\"housenumber\":\"30\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4397208\",\"longitude\":\"30.6095525\"}","sp_object":"20"},{"uri":"map\/mykolaichuka-ivana\/7","id":"63","pagetitle":"7","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u041c\u0438\u043a\u043e\u043b\u0430\u0439\u0447\u0443\u043a\u0430 \u0406\u0432\u0430\u043d\u0430\",\"housenumber\":\"7\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4314105\",\"longitude\":\"30.5980012\"}","sp_object":""},{"uri":"map\/mykolaichuka-ivana\/7a","id":"64","pagetitle":"7\u0430","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u041c\u0438\u043a\u043e\u043b\u0430\u0439\u0447\u0443\u043a\u0430 \u0406\u0432\u0430\u043d\u0430\",\"housenumber\":\"7\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4319376\",\"longitude\":\"30.5992522\"}","sp_object":""},{"uri":"map\/sobornosti\/30","id":"65","pagetitle":"30","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0421\u043e\u0431\u043e\u0440\u043d\u043e\u0441\u0442\u0456\",\"housenumber\":\"30\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4388283\",\"longitude\":\"30.6101723\"}","sp_object":"20"},{"uri":"map\/buchmy-amvrosiia\/51","id":"59","pagetitle":"5\/1","coverage_status":"0","backup_power":"24","gmap":"{\"street\":\"\u0411\u0443\u0447\u043c\u0438 \u0410\u043c\u0432\u0440\u043e\u0441\u0456\u044f\",\"housenumber\":\"5\/1\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4320893\",\"longitude\":\"30.6058503\"}","sp_object":""},{"uri":"map\/mykolaichuka-ivana\/4","id":"60","pagetitle":"4","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u041c\u0438\u043a\u043e\u043b\u0430\u0439\u0447\u0443\u043a\u0430 \u0406\u0432\u0430\u043d\u0430\",\"housenumber\":\"4\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.433463\",\"longitude\":\"30.6008279\"}","sp_object":""},{"uri":"map\/mykolaichuka-ivana\/5","id":"61","pagetitle":"5","coverage_status":"0","backup_power":"72","gmap":"{\"street\":\"\u041c\u0438\u043a\u043e\u043b\u0430\u0439\u0447\u0443\u043a\u0430 \u0406\u0432\u0430\u043d\u0430\",\"housenumber\":\"5\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4308749\",\"longitude\":\"30.5970096\"}","sp_object":""},{"uri":"map\/mykolaichuka-ivana\/51","id":"62","pagetitle":"5\/1","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u041c\u0438\u043a\u043e\u043b\u0430\u0439\u0447\u0443\u043a\u0430 \u0406\u0432\u0430\u043d\u0430\",\"housenumber\":\"5\/1\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4306684\",\"longitude\":\"30.59824069999999\"}","sp_object":""},{"uri":"map\/buchmy-amvrosiia\/1","id":"55","pagetitle":"1","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0411\u0443\u0447\u043c\u0438 \u0410\u043c\u0432\u0440\u043e\u0441\u0456\u044f\",\"housenumber\":\"1\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.43293509999999\",\"longitude\":\"30.6036644\"}","sp_object":""},{"uri":"map\/buchmy-amvrosiia\/3","id":"56","pagetitle":"3","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0411\u0443\u0447\u043c\u0438 \u0410\u043c\u0432\u0440\u043e\u0441\u0456\u044f\",\"housenumber\":\"3\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4325667\",\"longitude\":\"30.6048208\"}","sp_object":""},{"uri":"map\/buchmy-amvrosiia\/4","id":"57","pagetitle":"4","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0411\u0443\u0447\u043c\u0438 \u0410\u043c\u0432\u0440\u043e\u0441\u0456\u044f\",\"housenumber\":\"4\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.43223709999999\",\"longitude\":\"30.6020364\"}","sp_object":""},{"uri":"map\/buchmy-amvrosiia\/5","id":"58","pagetitle":"5","coverage_status":"0","backup_power":"72","gmap":"{\"street\":\"\u0411\u0443\u0447\u043c\u0438 \u0410\u043c\u0432\u0440\u043e\u0441\u0456\u044f\",\"housenumber\":\"5\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4318921\",\"longitude\":\"30.6048734\"}","sp_object":""},{"uri":"map\/berezniakivska\/10","id":"52","pagetitle":"10","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"10\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4338299\",\"longitude\":\"30.6127406\"}","sp_object":""},{"uri":"map\/berezniakivska\/14a","id":"53","pagetitle":"14\u0430","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"14\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.43044219999999\",\"longitude\":\"30.6126758\"}","sp_object":""},{"uri":"map\/berezniakivska\/16","id":"54","pagetitle":"16","coverage_status":"0","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"16\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.428454\",\"longitude\":\"30.6129724\"}","sp_object":""},{"uri":"map\/berezniakivska\/4a","id":"50","pagetitle":"4\u0430","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"4\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.434952\",\"longitude\":\"30.610698\"}","sp_object":""},{"uri":"map\/berezniakivska\/6","id":"51","pagetitle":"6","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"6\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.43535079999999\",\"longitude\":\"30.6121968\"}","sp_object":""},{"uri":"map\/berezniakivska\/4","id":"49","pagetitle":"4","coverage_status":"0","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"4\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4359383\",\"longitude\":\"30.6115198\"}","sp_object":""},{"uri":"map\/berezniakivska\/2","id":"48","pagetitle":"2","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"2\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\u0423\u043a\u0440\u0430\u0457\u043d\u0430\",\"latitude\":\"50.4366104\",\"longitude\":\"30.6113689\"}","sp_object":""}];


  /*// Инициализация и добавление карты
  let map;

  async function initMap() {
    // Request needed libraries.
    const { Map, InfoWindow } = await google.maps.importLibrary("maps");
    const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

    const mapEl = document.getElementById('map');
    // const telMaskInit = function () {
    //   window.setTimeout(() => {
    //     const telElem = document.getElementsByClassName('tel-mask');
    //     if (!telElem) return;
    //     Array.prototype.forEach.call(telElem, function (item) {
    //       const telMask = IMask(
    //         item, {
    //           mask: '+{38\\0} (00) 000 00 00',
    //           lazy: true // 'false' make placeholder always visible
    //         });
    //     });
    //   }, 100);
    // };

    const mapIdLight ="1ba02fcecc153be989d2ce78";
    const mapIdDark ="1ba02fcecc153be9166c94d4";

    // Добавление карты с центром города
    const map = new Map(mapEl, {
      zoom: 12,
      maxZoom: 18,
      center: { lat: 50.4501, lng: 30.5234 },  // Координаты Киева
      mapId: mapIdLight  //  DEMO_MAP_ID // mapIdLight
    });

    // --- Масштабирование --------------

    var LatLngList = [];

    for (let i = 0; i < coverageMap.length; i++) {
      let gmapData = coverageMap[i].gmap;

      // Преобразование gmap из строки в объект
      if (typeof gmapData === "string") {
        try {
          gmapData = JSON.parse(gmapData);
        } catch (error) {
          console.error("Ошибка парсинга JSON для gmap:", error, gmapData);
          continue;
        }
      }

      let latEl = gmapData.latitude;
      let lngEl = gmapData.longitude;

      if (latEl !== undefined && lngEl !== undefined) {
        let listEl = new google.maps.LatLng(parseFloat(latEl), parseFloat(lngEl));
        if (JSON.stringify(listEl) === '{"lat":0,"lng":0}') {
          continue;
        }
        LatLngList.push(listEl);
      }
    }

    var bounds = new google.maps.LatLngBounds();
    for (let j = 0; j < LatLngList.length; j++) {
      bounds.extend(LatLngList[j]);
    }
    map.fitBounds(bounds);

    // -----------------

    const infoWindow = new InfoWindow({
      maxWidth: 325,
      minWidth: 300,
    });

    const markers = coverageMap.map((location) => {
      // Парсим строку JSON из gmap
      const gmap = JSON.parse(location.gmap);

      // Получаем иконку по статусу
      const iconSrc = getIcon(location.coverage_status || "0");

      // Создаём пользовательский HTML для маркера
      const markerElement = document.createElement('div');
      markerElement.classList.add('custom-marker');

      const iconImg = document.createElement('img');
      iconImg.src = iconSrc;
      iconImg.alt = location.coverage_status || "No Data";
      iconImg.style.width = '56px';
      iconImg.style.height = '56px';

      markerElement.appendChild(iconImg);

      // Создаём маркер
      const marker = new google.maps.marker.AdvancedMarkerElement({
        position: {
          lat: parseFloat(gmap.latitude),
          lng: parseFloat(gmap.longitude),
        },
        content: markerElement,
        title: gmap.street + ' ' + gmap.housenumber,
      });

      const contentString = `
        <div class="infowindow">
          <p class="h6 infowindow__title" style="color: #121721;">${marker.title}</p>

        </div>
      `;

      marker.addListener('click', ({ domEvent, latLng }) => {
        const { target } = domEvent;

        infoWindow.setContent(contentString);
        infoWindow.open(map, marker);
        //telMaskInit();
      });

      return marker;
    });

    const markerCluster = new markerClusterer.MarkerClusterer({ markers, map });

    // Function to get icon based on coverage type
    // connected or planned
    function getIcon(status) {
      const icons = {
        1: '/img/ip-tv.svg',  // Подключено ?
        0: '/img/ip.svg', // Планируется подключение ?
      };

      // Если статус пустой или отсутствует, используем значение по умолчанию
      return icons[status] || '/img/ip.svg';
    }
  }

  initMap();*/

  // --- Управление открытием окон ---
  let currentInfoWindow = null;

  // --- Инициализация карты ---
  async function initMap() {
    const { Map, OverlayView } = await google.maps.importLibrary("maps");
    const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

    // --- Кастомный InfoWindow: класс ---
    // class CustomInfoWindow extends google.maps.OverlayView {
    //   constructor(map, position, data = {}) {
    //     super();
    //     this.map = map;
    //     this.position = position;
    //     this.data = data;
    //     this.div = null; // корневой div окна
    //     this.lastFocusedElement = null; // для возврата фокуса
    //     this.setMap(map); // OverlayView API
    //   }

    //   // Создаем DOM из <template>
    //   onAdd() {
    //     // Получаем шаблон
    //     const template = document.getElementById('infowindow-custom');
    //     const clone = template.content.cloneNode(true);

    //     // --- Динамические данные ---
    //     // Пример расширяемого API для вставки данных (можно добавить новые поля)
    //     const mapFields = [
    //       { selector: '.infowindow-template__backup-time', value: this.data.backup_power },
    //       { selector: '.infowindow-template__street', value: this.data.street },
    //       { selector: '.infowindow-template__apartment', value: this.data.housenumber }
    //       // Дополнительно: новые поля также добавлять сюда
    //     ];
    //     mapFields.forEach(field => {
    //       const el = clone.querySelector(field.selector);
    //       if (el && field.value !== undefined) el.textContent = field.value;
    //     });

    //     // --- accessibility: добавляем role/aria при открытии ---
    //     const root = clone.querySelector('.infowindow-template');
    //     root.setAttribute('aria-modal', 'true');
    //     root.setAttribute('role', 'dialog');
    //     root.setAttribute('aria-hidden', 'false');

    //     // --- Анимация открытия (zoom) ---
    //     root.style.transform = 'scale(0.5)';
    //     root.style.opacity = '0';
    //     root.style.transition = 'transform 0.25s cubic-bezier(.4,1.6,.4,1), opacity 0.25s';

    //     // --- Основной div-обёртка для Overlay ---
    //     const div = document.createElement('div');
    //     div.appendChild(clone);
    //     div.className = 'infowindow-template-wrapper';
    //     div.style.position = 'absolute';

    //     this.div = div;

    //     // --- Добавляем div в overlay карты ---
    //     const panes = this.getPanes();
    //     panes.floatPane.appendChild(div);

    //     // --- Фокусировка на первом input ---
    //     const firstInput = div.querySelector('.infowindow-template input, .infowindow-template input[type="text"]');
    //     if (firstInput) {
    //       // Сохраняем последний фокус
    //       this.lastFocusedElement = document.activeElement;
    //       setTimeout(() => firstInput.focus(), 10);
    //     }

    //     // --- Анимация: запускаем открытие ---
    //     setTimeout(() => {
    //       root.style.transform = 'scale(1)';
    //       root.style.opacity = '1';
    //     }, 10);

    //     // --- Обработка клавиатуры для закрытия по Esc и Tab ---
    //     this._onKeyDown = (e) => {
    //       if (e.key === 'Escape') this.close();
    //       if (e.key === 'Tab') this._trapFocus(e);
    //     };
    //     document.addEventListener('keydown', this._onKeyDown);

    //     // --- Клик вне окна: закрыть ---
    //     this._onClick = (e) => {
    //       if (this.div && !this.div.contains(e.target)) this.close();
    //     };
    //     setTimeout(() => document.addEventListener('mousedown', this._onClick), 0); // задержка чтобы не сработало на маркере

    //     // --- Автоскролл к маркеру ---
    //     if (this.map && this.position) {
    //       this.map.panTo(this.position);
    //     }
    //   }

    //   // Правильное позиционирование
    //   draw() {
    //     if (!this.div) return;
    //     const overlayProjection = this.getProjection();
    //     const pos = overlayProjection.fromLatLngToDivPixel(this.position);

    //     // Центрируем окно над маркером (можно настроить по UX)
    //     const div = this.div;
    //     div.style.left = `${pos.x - 160}px`; // ширина окна ~320px
    //     div.style.top = `${pos.y - 25}px`;   // немного выше центра маркера
    //   }

    //   // Закрытие окна: удаляем обработчики, анимация
    //   close() {
    //     if (!this.div) return;

    //     // accessibility: удаляем role/aria
    //     const root = this.div.querySelector('.infowindow-template');
    //     if (root) {
    //       root.removeAttribute('aria-modal');
    //       root.removeAttribute('role');
    //       root.setAttribute('aria-hidden', 'true');
    //     }

    //     // Анимация закрытия (можно добавить fade)
    //     if (root) {
    //       root.style.transform = 'scale(0.5)';
    //       root.style.opacity = '0';
    //     }

    //     setTimeout(() => {
    //       if (this.div && this.div.parentNode) {
    //         this.div.parentNode.removeChild(this.div);
    //       }
    //       this.div = null;
    //     }, 200);

    //     // Возвращаем фокус на предыдущий элемент
    //     if (this.lastFocusedElement) {
    //       setTimeout(() => this.lastFocusedElement.focus(), 10);
    //     }

    //     // Снимаем обработчики
    //     document.removeEventListener('keydown', this._onKeyDown);
    //     document.removeEventListener('mousedown', this._onClick);

    //     // Оповещаем, что окно закрыто (для автосворачивания)
    //     if (this.onClose) this.onClose();
    //   }

    //   // OverlayView API: удаляем при remove
    //   onRemove() {
    //     if (this.div && this.div.parentNode) {
    //       this.div.parentNode.removeChild(this.div);
    //     }
    //     this.div = null;
    //     document.removeEventListener('keydown', this._onKeyDown);
    //     document.removeEventListener('mousedown', this._onClick);
    //   }

    //   // trapFocus: чтобы Tab не выходил за пределы окна
    //   _trapFocus(e) {
    //     const focusable = this.div.querySelectorAll('input, button, [tabindex]:not([tabindex="-1"])');
    //     if (!focusable.length) return;
    //     const first = focusable[0];
    //     const last = focusable[focusable.length - 1];
    //     if (e.shiftKey) {
    //       if (document.activeElement === first) {
    //         last.focus();
    //         e.preventDefault();
    //       }
    //     } else {
    //       if (document.activeElement === last) {
    //         first.focus();
    //         e.preventDefault();
    //       }
    //     }
    //   }
    // }

    // class CustomInfoWindow extends google.maps.OverlayView {
    //   constructor(map, marker, data = {}) {
    //     super();
    //     this.map = map;
    //     this.marker = marker; // Сохраняем маркер для доступа к его позиции
    //     this.data = data;
    //     this.div = null;
    //     this.lastFocusedElement = null;
    //     this.markerSize = { width: 56, height: 56 }; // Фиксированные размеры маркера
    //     this.windowSize = { width: 0, height: 0 }; // Для хранения реальных размеров окна
    //     this.setMap(map);
    //   }

    //   // Создание DOM-элементов на основе шаблона
    //   onAdd() {
    //     const template = document.getElementById('infowindow-custom');
    //     const clone = template.content.cloneNode(true);

    //     // Динамическая вставка данных с учётом возможных пропусков
    //     const mapFields = [
    //       { selector: '.infowindow-template__backup-time', value: this.data.backup_power || '' },
    //       { selector: '.infowindow-template__street', value: this.data.street || '' },
    //       { selector: '.infowindow-template__apartment', value: this.data.housenumber || '' }
    //     ];
    //     mapFields.forEach(field => {
    //       const el = clone.querySelector(field.selector);
    //       if (el && field.value !== undefined) el.textContent = field.value;
    //     });

    //     // Настройка доступности
    //     const root = clone.querySelector('.infowindow-template');
    //     root.setAttribute('aria-modal', 'true');
    //     root.setAttribute('role', 'dialog');
    //     root.setAttribute('aria-hidden', 'false');

    //     // Анимация открытия (масштабирование)
    //     root.style.transform = 'scale(0.5)';
    //     root.style.opacity = '0';
    //     root.style.transition = 'transform 0.25s cubic-bezier(.4,1.6,.4,1), opacity 0.25s';

    //     // Создание обёртки для Overlay
    //     const div = document.createElement('div');
    //     div.appendChild(clone);
    //     div.className = 'infowindow-template-wrapper';
    //     div.style.position = 'absolute';

    //     this.div = div;

    //     // Добавление в слой карты
    //     const panes = this.getPanes();
    //     panes.floatPane.appendChild(div);

    //     // Измерение реальных размеров окна после добавления
    //     setTimeout(() => {
    //       const windowRect = this.div.getBoundingClientRect();
    //       this.windowSize.width = windowRect.width;
    //       this.windowSize.height = windowRect.height;
    //       this.draw(); // Перерисовка с реальными размерами
    //     }, 0);

    //     // Фокус на первом input
    //     const firstInput = div.querySelector('.infowindow-template input, .infowindow-template input[type="text"]');
    //     if (firstInput) {
    //       this.lastFocusedElement = document.activeElement;
    //       setTimeout(() => firstInput.focus(), 10);
    //     }

    //     // Запуск анимации открытия
    //     setTimeout(() => {
    //       root.style.transform = 'scale(1)';
    //       root.style.opacity = '1';
    //     }, 10);

    //     // Обработчики клавиатуры и кликов
    //     this._onKeyDown = (e) => {
    //       if (e.key === 'Escape') this.close();
    //       if (e.key === 'Tab') this._trapFocus(e);
    //     };
    //     document.addEventListener('keydown', this._onKeyDown);

    //     this._onClick = (e) => {
    //       if (this.div && !this.div.contains(e.target)) this.close();
    //     };
    //     setTimeout(() => document.addEventListener('mousedown', this._onClick), 0);

    //     // Автоскролл к маркеру
    //     if (this.map && this.marker.position) {
    //       this.map.panTo(this.marker.position);
    //     }
    //   }

    //   // Обновление позиции окна относительно маркера
    //   draw() {
    //     if (!this.div || !this.marker.position) return;

    //     const overlayProjection = this.getProjection();
    //     const pos = overlayProjection.fromLatLngToDivPixel(this.marker.position); // Используем позицию маркера

    //     // Фиксированные размеры маркера
    //     const markerWidth = this.markerSize.width;
    //     const markerHeight = this.markerSize.height;

    //     // Реальные размеры окна
    //     const windowWidth = this.windowSize.width || 320; // Значение по умолчанию
    //     const windowHeight = this.windowSize.height || 322; // Значение по умолчанию

    //     // Размещение окна над маркером
    //     const div = this.div;
    //     div.style.left = `${pos.x - windowWidth / 2}px`; // Центр по горизонтали
    //     div.style.top = `${pos.y - windowHeight - markerHeight - 15}px`; // Верх окна выше маркера на высоту окна + высоту маркера + 15px (10px + 5px)

    //     // Убедимся, что окно не выходит за границы карты
    //     const mapRect = this.map.getDiv().getBoundingClientRect();
    //     const windowRect = div.getBoundingClientRect();
    //     if (windowRect.left < mapRect.left) div.style.left = `${mapRect.left}px`;
    //     if (windowRect.right > mapRect.right) div.style.left = `${mapRect.right - windowWidth}px`;
    //     if (windowRect.top < mapRect.top) div.style.top = `${mapRect.top}px`;
    //   }

    //   // Закрытие окна с анимацией
    //   close() {
    //     if (!this.div) return;

    //     const root = this.div.querySelector('.infowindow-template');
    //     if (root) {
    //       root.removeAttribute('aria-modal');
    //       root.removeAttribute('role');
    //       root.setAttribute('aria-hidden', 'true');

    //       // Анимация закрытия (масштабирование и затухание)
    //       root.style.transform = 'scale(0.5)';
    //       root.style.opacity = '0';
    //       root.style.transition = 'transform 0.25s cubic-bezier(.4,1.6,.4,1), opacity 0.25s';
    //     }

    //     setTimeout(() => {
    //       if (this.div && this.div.parentNode) {
    //         this.div.parentNode.removeChild(this.div);
    //       }
    //       this.div = null;
    //     }, 250);

    //     if (this.lastFocusedElement) {
    //       setTimeout(() => this.lastFocusedElement.focus(), 10);
    //     }

    //     document.removeEventListener('keydown', this._onKeyDown);
    //     document.removeEventListener('mousedown', this._onClick);

    //     if (this.onClose) this.onClose();
    //   }

    //   // Удаление при очистке
    //   onRemove() {
    //     if (this.div && this.div.parentNode) {
    //       this.div.parentNode.removeChild(this.div);
    //     }
    //     this.div = null;
    //     document.removeEventListener('keydown', this._onKeyDown);
    //     document.removeEventListener('mousedown', this._onClick);
    //   }

    //   // Ловушка фокуса для клавиатуры
    //   _trapFocus(e) {
    //     const focusable = this.div.querySelectorAll('input, button, [tabindex]:not([tabindex="-1"])');
    //     if (!focusable.length) return;
    //     const first = focusable[0];
    //     const last = focusable[focusable.length - 1];
    //     if (e.shiftKey) {
    //       if (document.activeElement === first) {
    //         last.focus();
    //         e.preventDefault();
    //       }
    //     } else {
    //       if (document.activeElement === last) {
    //         first.focus();
    //         e.preventDefault();
    //       }
    //     }
    //   }
    // }

    /*class CustomInfoWindow extends google.maps.OverlayView {
      constructor(map, marker, data = {}) {
        super();
        this.map = map;
        this.marker = marker; // Сохраняем маркер для доступа к его позиции
        this.data = data;
        this.div = null;
        this.lastFocusedElement = null;
        this.markerSize = { width: 56, height: 56 }; // Фиксированные размеры маркера
        this.windowSize = { width: 0, height: 0 }; // Для хранения реальных размеров окна
        this.setMap(map);
      }

      // Создание DOM-элементов на основе шаблона
      onAdd() {
        const template = document.getElementById('infowindow-custom');
        const clone = template.content.cloneNode(true);

        // Динамическая вставка данных с учётом возможных пропусков
        const mapFields = [
          { selector: '.infowindow-template__backup-time', value: this.data.backup_power || '72h' },
          { selector: '.infowindow-template__street', value: this.data.street || '' },
          { selector: '.infowindow-template__apartment', value: this.data.housenumber || '' }
        ];
        mapFields.forEach(field => {
          const el = clone.querySelector(field.selector);
          if (el && field.value !== undefined) el.textContent = field.value;
        });

        // Настройка доступности
        const root = clone.querySelector('.infowindow-template');
        root.setAttribute('aria-modal', 'true');
        root.setAttribute('role', 'dialog');
        root.setAttribute('aria-hidden', 'false');

        // Анимация открытия (масштабирование)
        root.style.transform = 'scale(0.5)';
        root.style.opacity = '0';
        root.style.transition = 'transform 0.25s cubic-bezier(.4,1.6,.4,1), opacity 0.25s';

        // Создание обёртки для Overlay
        const div = document.createElement('div');
        div.appendChild(clone);
        div.className = 'infowindow-template-wrapper';
        div.style.position = 'absolute';

        this.div = div;

        // Добавление в слой карты
        const panes = this.getPanes();
        panes.floatPane.appendChild(div);

        // Измерение реальных размеров окна после добавления
        setTimeout(() => {
          const windowRect = this.div.getBoundingClientRect();
          this.windowSize.width = windowRect.width;
          this.windowSize.height = windowRect.height;
          this.draw(); // Перерисовка с реальными размерами
        }, 0);

        // Фокус на первом input
        const firstInput = div.querySelector('.infowindow-template input, .infowindow-template input[type="text"]');
        if (firstInput) {
          this.lastFocusedElement = document.activeElement;
          setTimeout(() => firstInput.focus(), 10);
        }

        // Запуск анимации открытия
        setTimeout(() => {
          root.style.transform = 'scale(1)';
          root.style.opacity = '1';
        }, 10);

        // Обработчики клавиатуры и кликов
        this._onKeyDown = (e) => {
          if (e.key === 'Escape') this.close();
          if (e.key === 'Tab') this._trapFocus(e);
        };
        document.addEventListener('keydown', this._onKeyDown);

        this._onClick = (e) => {
          if (this.div && !this.div.contains(e.target)) this.close();
        };
        setTimeout(() => document.addEventListener('mousedown', this._onClick), 0);

        // Автоскролл к маркеру
        if (this.map && this.marker.position) {
          this.map.panTo(this.marker.position);
        }
      }

      // Обновление позиции окна относительно маркера
      draw() {
        if (!this.div || !this.marker.position) return;

        const overlayProjection = this.getProjection();
        const pos = overlayProjection.fromLatLngToDivPixel(this.marker.position); // Координата центра маркера

        // Фиксированные размеры маркера
        const markerWidth = this.markerSize.width;
        const markerHeight = this.markerSize.height;

        // Реальные размеры окна
        const windowWidth = this.windowSize.width || 320; // Значение по умолчанию
        const windowHeight = this.windowSize.height || 322; // Значение по умолчанию

        // Базовая позиция (над маркером)
        let top = pos.y - windowHeight - markerHeight - 15;

        // Получение границ карты в пикселях
        const mapDiv = this.map.getDiv();
        const mapRect = mapDiv.getBoundingClientRect();
        const mapTop = mapRect.top + window.pageYOffset; // Абсолютная позиция верхней границы
        const mapBottom = mapRect.bottom + window.pageYOffset; // Абсолютная позиция нижней границы

        // Корректировка, чтобы окно полностью помещалось в видимую область
        const windowBottom = top + windowHeight;

        if (top < mapTop) {
          // Если верх окна выше видимой области, смещаем вниз
          top = pos.y - markerHeight + 56; // Минимально над маркером
        }
        if (windowBottom > mapBottom) {
          // Если низ окна ниже видимой области, смещаем вверх
          top = Math.max(mapTop, mapBottom - windowHeight); // Не выше верхней границы
        }

        // Центрирование по горизонтали
        const div = this.div;
        div.style.left = `${pos.x - windowWidth / 2}px`;
        div.style.top = `${top}px`;

        // Дополнительная проверка границ
        const windowRect = div.getBoundingClientRect();
        if (windowRect.left < mapRect.left) div.style.left = `${mapRect.left}px`;
        if (windowRect.right > mapRect.right) div.style.left = `${mapRect.right - windowWidth}px`;
        if (windowRect.top < mapRect.top) div.style.top = `${mapRect.top + window.pageYOffset}px`;
      }

      // Закрытие окна с анимацией
      close() {
        if (!this.div) return;

        const root = this.div.querySelector('.infowindow-template');
        if (root) {
          root.removeAttribute('aria-modal');
          root.removeAttribute('role');
          root.setAttribute('aria-hidden', 'true');

          // Анимация закрытия (масштабирование и затухание)
          root.style.transform = 'scale(0.5)';
          root.style.opacity = '0';
          root.style.transition = 'transform 0.25s cubic-bezier(.4,1.6,.4,1), opacity 0.25s';
        }

        setTimeout(() => {
          if (this.div && this.div.parentNode) {
            this.div.parentNode.removeChild(this.div);
          }
          this.div = null;
        }, 250);

        if (this.lastFocusedElement) {
          setTimeout(() => this.lastFocusedElement.focus(), 10);
        }

        document.removeEventListener('keydown', this._onKeyDown);
        document.removeEventListener('mousedown', this._onClick);

        if (this.onClose) this.onClose();
      }

      // Удаление при очистке
      onRemove() {
        if (this.div && this.div.parentNode) {
          this.div.parentNode.removeChild(this.div);
        }
        this.div = null;
        document.removeEventListener('keydown', this._onKeyDown);
        document.removeEventListener('mousedown', this._onClick);
      }

      // Ловушка фокуса для клавиатуры
      _trapFocus(e) {
        const focusable = this.div.querySelectorAll('input, button, [tabindex]:not([tabindex="-1"])');
        if (!focusable.length) return;
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (e.shiftKey) {
          if (document.activeElement === first) {
            last.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === last) {
            first.focus();
            e.preventDefault();
          }
        }
      }
    }*/

    class CustomInfoWindow extends google.maps.OverlayView {
      constructor(map, marker, data = {}) {
        super();
        this.map = map;
        this.marker = marker; // Сохраняем маркер для доступа к его позиции
        this.data = data;
        this.div = null;
        this.lastFocusedElement = null;
        this.markerSize = { width: 56, height: 56 }; // Фиксированные размеры маркера
        this.windowSize = { width: 0, height: 0 }; // Для хранения реальных размеров окна
        this.setMap(map);
      }

      // Создание DOM-элементов на основе шаблона
      onAdd() {
        const template = document.getElementById('infowindow-custom');
        const clone = template.content.cloneNode(true);

        // Динамическая вставка данных с учётом возможных пропусков
        const mapFields = [
          { selector: '.infowindow-template__backup-time', value: this.data.backup_power || '72h' },
          { selector: '.infowindow-template__street', value: this.data.street || '' },
          { selector: '.infowindow-template__apartment', value: this.data.housenumber || '' }
        ];
        mapFields.forEach(field => {
          const el = clone.querySelector(field.selector);
          if (el && field.value !== undefined) el.textContent = field.value;
        });

        // Настройка доступности
        const root = clone.querySelector('.infowindow-template');
        root.setAttribute('aria-modal', 'true');
        root.setAttribute('role', 'dialog');
        root.setAttribute('aria-hidden', 'false');

        // Анимация открытия (масштабирование)
        root.style.transform = 'scale(0.5)';
        root.style.opacity = '0';
        root.style.transition = 'transform 0.25s cubic-bezier(.4,1.6,.4,1), opacity 0.25s';

        // Создание обёртки для Overlay
        const div = document.createElement('div');
        div.appendChild(clone);
        div.className = 'infowindow-template-wrapper';
        div.style.position = 'absolute';

        this.div = div;

        // Добавление в слой карты
        const panes = this.getPanes();
        panes.floatPane.appendChild(div);

        // Измерение реальных размеров окна после добавления
        setTimeout(() => {
          const windowRect = this.div.getBoundingClientRect();
          this.windowSize.width = windowRect.width;
          this.windowSize.height = windowRect.height;
          this.draw(); // Перерисовка с реальными размерами
        }, 0);

        // Фокус на первом input
        const firstInput = div.querySelector('.infowindow-template input, .infowindow-template input[type="text"]');
        if (firstInput) {
          this.lastFocusedElement = document.activeElement;
          setTimeout(() => firstInput.focus(), 10);
        }

        // Запуск анимации открытия
        setTimeout(() => {
          root.style.transform = 'scale(1)';
          root.style.opacity = '1';
        }, 10);

        // Обработчик клавиатуры
        this._onKeyDown = (e) => {
          if (e.key === 'Escape') this.close();
          if (e.key === 'Tab') this._trapFocus(e);
        };
        document.addEventListener('keydown', this._onKeyDown);

        // Обработчик закрытия по кнопке
        const closeButton = div.querySelector('.infowindow-template__close');
        if (closeButton) {
          closeButton.setAttribute('type', 'button');
          closeButton.setAttribute('aria-label', 'Закрыть информационное окно');
          closeButton.addEventListener('click', () => this.close());
        }

        // Автоскролл к маркеру
        if (this.map && this.marker.position) {
          this.map.panTo(this.marker.position);
        }
      }

      // Обновление позиции окна относительно маркера
      draw() {
        if (!this.div || !this.marker.position) return;

        const overlayProjection = this.getProjection();
        const pos = overlayProjection.fromLatLngToDivPixel(this.marker.position); // Координата центра маркера

        // Фиксированные размеры маркера
        const markerWidth = this.markerSize.width;
        const markerHeight = this.markerSize.height;

        // Реальные размеры окна
        const windowWidth = this.windowSize.width || 320; // Значение по умолчанию
        const windowHeight = this.windowSize.height || 322; // Значение по умолчанию

        // Базовая позиция (над маркером)
        let top = pos.y - windowHeight - markerHeight - 15;

        // Получение границ карты в пикселях
        const mapDiv = this.map.getDiv();
        const mapRect = mapDiv.getBoundingClientRect();
        const mapTop = mapRect.top + window.pageYOffset; // Абсолютная позиция верхней границы
        const mapBottom = mapRect.bottom + window.pageYOffset; // Абсолютная позиция нижней границы

        // Корректировка, чтобы окно полностью помещалось в видимую область
        const windowBottom = top + windowHeight;

        if (top < mapTop) {
          // Если верх окна выше видимой области, смещаем вниз
          top = pos.y - markerHeight + 56; // Минимально над маркером
        }
        if (windowBottom > mapBottom) {
          // Если низ окна ниже видимой области, смещаем вверх
          top = Math.max(mapTop, mapBottom - windowHeight); // Не выше верхней границы
        }

        // Центрирование по горизонтали
        const div = this.div;
        div.style.left = `${pos.x - windowWidth / 2}px`;
        div.style.top = `${top}px`;

        // Дополнительная проверка границ
        const windowRect = div.getBoundingClientRect();
        if (windowRect.left < mapRect.left) div.style.left = `${mapRect.left}px`;
        if (windowRect.right > mapRect.right) div.style.left = `${mapRect.right - windowWidth}px`;
        if (windowRect.top < mapRect.top) div.style.top = `${mapRect.top + window.pageYOffset}px`;
      }

      // Закрытие окна с анимацией
      close() {
        if (!this.div) return;

        const root = this.div.querySelector('.infowindow-template');
        if (root) {
          root.removeAttribute('aria-modal');
          root.removeAttribute('role');
          root.setAttribute('aria-hidden', 'true');

          // Анимация закрытия (масштабирование и затухание)
          root.style.transform = 'scale(0.5)';
          root.style.opacity = '0';
          root.style.transition = 'transform 0.25s cubic-bezier(.4,1.6,.4,1), opacity 0.25s';
        }

        setTimeout(() => {
          if (this.div && this.div.parentNode) {
            this.div.parentNode.removeChild(this.div);
          }
          this.div = null;
        }, 250);

        if (this.lastFocusedElement) {
          setTimeout(() => this.lastFocusedElement.focus(), 10);
        }

        document.removeEventListener('keydown', this._onKeyDown);

        if (this.onClose) this.onClose();
      }

      // Удаление при очистке
      onRemove() {
        if (this.div && this.div.parentNode) {
          this.div.parentNode.removeChild(this.div);
        }
        this.div = null;
        document.removeEventListener('keydown', this._onKeyDown);
      }

      // Ловушка фокуса для клавиатуры
      _trapFocus(e) {
        const focusable = this.div.querySelectorAll('input, button, [tabindex]:not([tabindex="-1"])');
        if (!focusable.length) return;
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (e.shiftKey) {
          if (document.activeElement === first) {
            last.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === last) {
            first.focus();
            e.preventDefault();
          }
        }
      }
    }


    const mapEl = document.getElementById('map');
    const mapIdLight = "1ba02fcecc153be989d2ce78";
    const mapIdDark = "1ba02fcecc153be9166c94d4";

    const map = new Map(mapEl, {
      zoom: 12,
      maxZoom: 19,
      center: { lat: 50.4501, lng: 30.5234 },
      mapId: mapIdLight
    });

    // --- Масштабирование по маркерам ---
    var LatLngList = [];
    for (let i = 0; i < coverageMap.length; i++) {
      let gmapData = coverageMap[i].gmap;
      if (typeof gmapData === "string") {
        try { gmapData = JSON.parse(gmapData); } catch (error) { continue; }
      }
      let latEl = gmapData.latitude;
      let lngEl = gmapData.longitude;
      if (latEl !== undefined && lngEl !== undefined) {
        let listEl = new google.maps.LatLng(parseFloat(latEl), parseFloat(lngEl));
        if (JSON.stringify(listEl) === '{"lat":0,"lng":0}') continue;
        LatLngList.push(listEl);
      }
    }
    var bounds = new google.maps.LatLngBounds();
    LatLngList.forEach(latlng => bounds.extend(latlng));
    map.fitBounds(bounds);

    // --- Маркеры ---
    const markers = coverageMap.map((location) => {
      const gmap = typeof location.gmap === "string" ? JSON.parse(location.gmap) : location.gmap;
      const iconSrc = getIcon(location.coverage_status || "0");

      // HTML для маркера
      const markerElement = document.createElement('div');
      markerElement.classList.add('custom-marker');
      const iconImg = document.createElement('img');
      iconImg.src = iconSrc;
      iconImg.alt = location.coverage_status || "No Data";
      iconImg.style.width = '56px';
      iconImg.style.height = '56px';
      markerElement.appendChild(iconImg);

      // Создаём маркер
      const marker = new AdvancedMarkerElement({
        position: {
          lat: parseFloat(gmap.latitude),
          lng: parseFloat(gmap.longitude),
        },
        content: markerElement,
        title: gmap.street + ' ' + gmap.housenumber,
      });

      // --- Клик по маркеру: открываем кастомное окно ---
      /*marker.addListener('click', ({ domEvent, latLng }) => {
        // Закрыть предыдущее окно
        if (currentInfoWindow) {
          currentInfoWindow.close();
          currentInfoWindow = null;
        }

        // Данные для окна
        const infoData = {
          backup_power: location.backup_power || '72h', // можно сделать дефолт
          street: gmap.street || '',
          housenumber: gmap.housenumber || '',
          // Можно добавить сюда любые новые поля!
        };

        // Открываем кастомный InfoWindow
        const infoWindow = new CustomInfoWindow(map, latLng, infoData);
        infoWindow.onClose = () => { currentInfoWindow = null; };
        currentInfoWindow = infoWindow;
      });*/
      marker.addListener('click', ({ domEvent, latLng }) => {
        if (currentInfoWindow) {
          currentInfoWindow.close();
          currentInfoWindow = null;
        }

        const infoData = {
          backup_power: location.backup_power || '72h',
          street: gmap.street || '',
          housenumber: gmap.housenumber || ''
        };

        const infoWindow = new CustomInfoWindow(map, marker, infoData);
        infoWindow.onClose = () => { currentInfoWindow = null; };
        currentInfoWindow = infoWindow;
      });

      return marker;
    });

    // --- Кластеризация маркеров (оставлено) ---
    const markerCluster = new markerClusterer.MarkerClusterer({ markers, map });

    // --- Получаем иконку по статусу ---
    function getIcon(status) {
      const icons = {
        1: '/img/ip-tv.svg',
        0: '/img/ip.svg',
      };
      return icons[status] || '/img/ip.svg';
    }
  }

  initMap();
});

