document.addEventListener('DOMContentLoaded', function () {

  const coverageMap = [{"uri":"map\/tychyny-pavla-pr\/9b","id":"71","pagetitle":"9\u0431","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"9\u0431\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4293093\",\"longitude\":\"30.603848\"}","sp_object":""},{"uri":"map\/tychyny-pavla-pr\/11","id":"72","pagetitle":"11","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"11\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.43076259999999\",\"longitude\":\"30.6073302\"}","sp_object":""},{"uri":"map\/tychyny-pavla-pr\/5","id":"67","pagetitle":"5","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"5\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4280716\",\"longitude\":\"30.5988107\"}","sp_object":""},{"uri":"map\/tychyny-pavla-pr\/5a","id":"68","pagetitle":"5\u0430","coverage_status":"0","backup_power":"24","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"5\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.42862539999999\",\"longitude\":\"30.6005389\"}","sp_object":""},{"uri":"map\/tychyny-pavla-pr\/9","id":"69","pagetitle":"9","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"9\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4293054\",\"longitude\":\"30.6038764\"}","sp_object":""},{"uri":"map\/tychyny-pavla-pr\/9a","id":"70","pagetitle":"9\u0430","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0422\u0438\u0447\u0438\u043d\u0438 \u041f\u0430\u0432\u043b\u0430 \u043f\u0440.\",\"housenumber\":\"9\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4301699\",\"longitude\":\"30.6009519\"}","sp_object":""},{"uri":"map\/sobornosti\/30a","id":"66","pagetitle":"30\u0430","coverage_status":"0","backup_power":"24","gmap":"{\"street\":\"\u0421\u043e\u0431\u043e\u0440\u043d\u043e\u0441\u0442\u0456\",\"housenumber\":\"30\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4397208\",\"longitude\":\"30.6095525\"}","sp_object":"20"},{"uri":"map\/mykolaichuka-ivana\/7","id":"63","pagetitle":"7","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u041c\u0438\u043a\u043e\u043b\u0430\u0439\u0447\u0443\u043a\u0430 \u0406\u0432\u0430\u043d\u0430\",\"housenumber\":\"7\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4314105\",\"longitude\":\"30.5980012\"}","sp_object":""},{"uri":"map\/mykolaichuka-ivana\/7a","id":"64","pagetitle":"7\u0430","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u041c\u0438\u043a\u043e\u043b\u0430\u0439\u0447\u0443\u043a\u0430 \u0406\u0432\u0430\u043d\u0430\",\"housenumber\":\"7\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4319376\",\"longitude\":\"30.5992522\"}","sp_object":""},{"uri":"map\/sobornosti\/30","id":"65","pagetitle":"30","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0421\u043e\u0431\u043e\u0440\u043d\u043e\u0441\u0442\u0456\",\"housenumber\":\"30\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4388283\",\"longitude\":\"30.6101723\"}","sp_object":"20"},{"uri":"map\/buchmy-amvrosiia\/51","id":"59","pagetitle":"5\/1","coverage_status":"0","backup_power":"24","gmap":"{\"street\":\"\u0411\u0443\u0447\u043c\u0438 \u0410\u043c\u0432\u0440\u043e\u0441\u0456\u044f\",\"housenumber\":\"5\/1\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4320893\",\"longitude\":\"30.6058503\"}","sp_object":""},{"uri":"map\/mykolaichuka-ivana\/4","id":"60","pagetitle":"4","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u041c\u0438\u043a\u043e\u043b\u0430\u0439\u0447\u0443\u043a\u0430 \u0406\u0432\u0430\u043d\u0430\",\"housenumber\":\"4\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.433463\",\"longitude\":\"30.6008279\"}","sp_object":""},{"uri":"map\/mykolaichuka-ivana\/5","id":"61","pagetitle":"5","coverage_status":"0","backup_power":"72","gmap":"{\"street\":\"\u041c\u0438\u043a\u043e\u043b\u0430\u0439\u0447\u0443\u043a\u0430 \u0406\u0432\u0430\u043d\u0430\",\"housenumber\":\"5\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4308749\",\"longitude\":\"30.5970096\"}","sp_object":""},{"uri":"map\/mykolaichuka-ivana\/51","id":"62","pagetitle":"5\/1","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u041c\u0438\u043a\u043e\u043b\u0430\u0439\u0447\u0443\u043a\u0430 \u0406\u0432\u0430\u043d\u0430\",\"housenumber\":\"5\/1\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4306684\",\"longitude\":\"30.59824069999999\"}","sp_object":""},{"uri":"map\/buchmy-amvrosiia\/1","id":"55","pagetitle":"1","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0411\u0443\u0447\u043c\u0438 \u0410\u043c\u0432\u0440\u043e\u0441\u0456\u044f\",\"housenumber\":\"1\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.43293509999999\",\"longitude\":\"30.6036644\"}","sp_object":""},{"uri":"map\/buchmy-amvrosiia\/3","id":"56","pagetitle":"3","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0411\u0443\u0447\u043c\u0438 \u0410\u043c\u0432\u0440\u043e\u0441\u0456\u044f\",\"housenumber\":\"3\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4325667\",\"longitude\":\"30.6048208\"}","sp_object":""},{"uri":"map\/buchmy-amvrosiia\/4","id":"57","pagetitle":"4","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0411\u0443\u0447\u043c\u0438 \u0410\u043c\u0432\u0440\u043e\u0441\u0456\u044f\",\"housenumber\":\"4\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.43223709999999\",\"longitude\":\"30.6020364\"}","sp_object":""},{"uri":"map\/buchmy-amvrosiia\/5","id":"58","pagetitle":"5","coverage_status":"0","backup_power":"72","gmap":"{\"street\":\"\u0411\u0443\u0447\u043c\u0438 \u0410\u043c\u0432\u0440\u043e\u0441\u0456\u044f\",\"housenumber\":\"5\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4318921\",\"longitude\":\"30.6048734\"}","sp_object":""},{"uri":"map\/berezniakivska\/10","id":"52","pagetitle":"10","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"10\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4338299\",\"longitude\":\"30.6127406\"}","sp_object":""},{"uri":"map\/berezniakivska\/14a","id":"53","pagetitle":"14\u0430","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"14\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.43044219999999\",\"longitude\":\"30.6126758\"}","sp_object":""},{"uri":"map\/berezniakivska\/16","id":"54","pagetitle":"16","coverage_status":"0","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"16\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.428454\",\"longitude\":\"30.6129724\"}","sp_object":""},{"uri":"map\/berezniakivska\/4a","id":"50","pagetitle":"4\u0430","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"4\u0430\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.434952\",\"longitude\":\"30.610698\"}","sp_object":""},{"uri":"map\/berezniakivska\/6","id":"51","pagetitle":"6","coverage_status":"1","backup_power":"72","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"6\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.43535079999999\",\"longitude\":\"30.6121968\"}","sp_object":""},{"uri":"map\/berezniakivska\/4","id":"49","pagetitle":"4","coverage_status":"0","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"4\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\",\"latitude\":\"50.4359383\",\"longitude\":\"30.6115198\"}","sp_object":""},{"uri":"map\/berezniakivska\/2","id":"48","pagetitle":"2","coverage_status":"1","backup_power":"24","gmap":"{\"street\":\"\u0411\u0435\u0440\u0435\u0437\u043d\u044f\u043a\u0456\u0432\u0441\u044c\u043a\u0430\",\"housenumber\":\"2\",\"zipcode\":\"\",\"city\":\"\u041a\u0438\u0457\u0432\",\"state\":\"\",\"country\":\"\u0423\u043a\u0440\u0430\u0457\u043d\u0430\",\"latitude\":\"50.4366104\",\"longitude\":\"30.6113689\"}","sp_object":""}];


  // --- Управление открытием окон ---
  let currentInfoWindow = null;

  // --- Инициализация карты ---
  async function initMap() {
    const { Map, InfoWindow } = await google.maps.importLibrary("maps");
    const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

    const mapEl = document.getElementById('map');
    const mapIdLight = "1ba02fcecc153be989d2ce78";
    const mapIdDark = "1ba02fcecc153be9166c94d4";

    const map = new Map(mapEl, {
      zoom: 12,
      maxZoom: 20,
      center: { lat: 50.4501, lng: 30.5234 },
      mapId: mapIdLight
    });

    // --- Масштабирование по маркерам ---
    var LatLngList = [];
    for (let i = 0; i < coverageMap.length; i++) {
      let gmapData = coverageMap[i].gmap;
      if (typeof gmapData === "string") {
        try { gmapData = JSON.parse(gmapData); } catch (error) { continue; }
      }
      let latEl = gmapData.latitude;
      let lngEl = gmapData.longitude;
      if (latEl !== undefined && lngEl !== undefined) {
        let listEl = new google.maps.LatLng(parseFloat(latEl), parseFloat(lngEl));
        if (JSON.stringify(listEl) === '{"lat":0,"lng":0}') continue;
        LatLngList.push(listEl);
      }
    }
    var bounds = new google.maps.LatLngBounds();
    LatLngList.forEach(latlng => bounds.extend(latlng));
    map.fitBounds(bounds);

    // --- Маркеры ---
    const markers = coverageMap.map((location) => {
      const gmap = typeof location.gmap === "string" ? JSON.parse(location.gmap) : location.gmap;
      const iconSrc = getIcon(location.coverage_status || "0");

      // HTML для маркера
      const markerElement = document.createElement('div');
      markerElement.classList.add('custom-marker');
      const iconImg = document.createElement('img');
      iconImg.src = iconSrc;
      iconImg.alt = location.coverage_status || "No Data";
      iconImg.style.width = '56px';
      iconImg.style.height = '56px';
      markerElement.appendChild(iconImg);

      // Создаём маркер
      const marker = new AdvancedMarkerElement({
        position: {
          lat: parseFloat(gmap.latitude),
          lng: parseFloat(gmap.longitude),
        },
        content: markerElement,
        title: gmap.street + ' ' + gmap.housenumber,
      });

      marker.addListener('click', ({ domEvent, latLng }) => {
        //domEvent.stopPropagation();
        //domEvent.preventDefault();

        if (currentInfoWindow) {
          currentInfoWindow.close();
          currentInfoWindow = null;
        }

        const infoData = {
          backup_power: location.backup_power || '72h',
          street: gmap.street || '',
          housenumber: gmap.housenumber || ''
        };

        // Создание содержимого окна
        const template = document.getElementById('infowindow-custom').content.cloneNode(true);
        const root = template.querySelector('.infowindow-template');
        //root.setAttribute('aria-modal', 'true');
        //root.setAttribute('role', 'dialog');
        //root.setAttribute('aria-hidden', 'false');

        // Заполнение данных
        const mapFields = [
          { selector: '.infowindow-template__backup-time', value: infoData.backup_power },
          { selector: '.infowindow-template__street', value: infoData.street },
          { selector: '.infowindow-template__apartment', value: infoData.housenumber }
        ];
        mapFields.forEach(field => {
          const el = template.querySelector(field.selector);
          if (el && field.value !== undefined) el.textContent = field.value;
        });

        // Анимация открытия
        //root.style.transform = 'scale(1)';
        root.style.opacity = '0';
        root.style.transition = 'opacity 0.25s';

        // Кнопка закрытия
        // const closeButton = template.querySelector('.infowindow-template__close');
        // if (closeButton) {
        //   closeButton.addEventListener('click', (e) => {
        //     e.stopPropagation();
        //     if (currentInfoWindow) {
        //       currentInfoWindow.close();
        //       currentInfoWindow = null;
        //     }
        //   });
        // }

        // Инициализация маски для phone-mask
        const phoneInputs = template.querySelectorAll('.phone-mask');
        if (phoneInputs.length && window.IMask) {
          phoneInputs.forEach(input => {
            IMask(input, {
              mask: '+{38} (\\000) 000 00 00',
              lazy: true, // make placeholder always visible
            });
          });
        }

        // Ловушка фокуса
        const focusable = template.querySelectorAll('input, button, [tabindex]:not([tabindex="-1"])');
        if (focusable.length) {
          setTimeout(() => {
            focusable[0].focus(); // Автоматический фокус на первом элементе
            //root.style.transform = 'scale(1)';
            root.style.opacity = '1';
          }, 50); // Ненадолго задерживаем для анимации
        }

        // Обработчик клавиатуры
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }
          if (e.key === 'Tab' && focusable.length) {
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (e.shiftKey && document.activeElement === first) {
              last.focus();
              e.preventDefault();
            } else if (!e.shiftKey && document.activeElement === last) {
              first.focus();
              e.preventDefault();
            }
          }
        });

        // Создание InfoWindow
        currentInfoWindow = new google.maps.InfoWindow({
          content: template,
          ariaLabel: `${infoData.street} ${infoData.housenumber}`,
          disableAutoPan: false
        });

        currentInfoWindow.open({
          anchor: marker,
          map,
          shouldFocus: true
        });

        currentInfoWindow.addListener('closeclick', () => {
          currentInfoWindow = null;
          document.removeEventListener('keydown', this._onKeyDown);
        });
      });

      return marker;
    });

    // --- Кластеризация маркеров (оставлено) ---
    const markerCluster = new markerClusterer.MarkerClusterer({ markers, map });

    // --- Получаем иконку по статусу ---
    function getIcon(status) {
      const icons = {
        1: '/img/ip-tv.svg',
        0: '/img/ip.svg',
      };
      return icons[status] || '/img/ip.svg';
    }
  }

  initMap();
});

